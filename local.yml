---
- name: Setup Machines
  hosts: localhost
  connection: local
  become: true
  
  tasks:  
  #INSTALL REPO
  #------------
  - name: Enable the RPM Fusion repository
    ansible.builtin.yum:
      name: "{{ item }}"
      state: present
      disable_gpg_check: true
    loop:
       - https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-{{ ansible_distribution_major_version }}.noarch.rpm
       - https://mirrors.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-{{ ansible_distribution_major_version }}.noarch.rpm

  #UPGRADE/INSTALL
  #------------
  - name: Install Nvidia
    dnf:
     name:
      - almalinux-release-nvidia-driver
      - nvidia-open-kmod
      - nvidia-driver
  
  - name: Modprobe nvidia_drm
    modprobe:
     name: nvidia_drm
     state: present

  - name: install cuda driver
    dnf:
     name:
      - nvidia-driver-cuda
      - cuda
      
  #- name: Upgrade all packages
   # ansible.builtin.yum:
    # name: "*"
     #state: latest
      
  #DOT FILES
  #------------
  - name: setup DNS
    copy:
     src: Files/resolv.conf
     dest: /etc/resolv.conf
     owner: root
     group: root

  - name: ENV Variables
    copy:
     src: Files/profile
     dest: /etc/profile
     owner: root
     group: root

  #PROGRAM DEPENDENCIES
  #------------
  - name: general dependencies
    yum:
     name:
      - bash
      - curl
      - dbus
      - perl
      - git
      - less

  - name: install houdini dependencies
    yum:
     name:
      - alsa-lib
      - cups-libs
      - dbus-libs
      - expat
      - fontconfig
      - glib2
      - glibc
      - libcurl
      - libdrm
      - libgcc
      - libglvnd-egl
      - libglvnd-glx
      - libglvnd-opengl
      - libICE
      - libSM
      - libstdc++
      - libuuid
      - libX11
      - libX11-xcb
      - libxcb
      - libXcomposite
      - libXdamage
      - libXext
      - libXfixes
      - libXi
      - libxkbcommon
      - libxkbcommon-x11
      - libxkbfile
      - libXrandr
      - libXrender
      - libxshmfence
      - libXt
      - libXtst
      - mesa-libGLU
      - ncurses-libs
      - nspr
      - nss
      - nss-util
      - nxagent
      - pciutils-libs
      - xcb-util-cursor
      - xcb-util-image
      - xcb-util-keysyms
      - xcb-util-renderutil
      - xcb-util-wm
     state: present
     
  - name: Install Cockpit & Dependencies
    yum:
     name:
      - cockpit
      - cockpit-storaged
      - cockpit-shell
      - samba-common-tools
      - adcli
      - sssd
      - realmd
      - oddjob
      - oddjob-mkhomedir
      - krb5-workstation
     state: present
  
  - name: Enable Cockpit on launch
    ansible.builtin.service:
     name: cockpit
     enabled: yes
     state: started 

  - name: Gnome Extensions
    ansible.builtin.command:
     cmd: "wget -O gnome-shell-extension-installer 'https://github.com/brunelli/gnome-shell-extension-installer/raw/master/gnome-shell-extension-installer'"
  
  - name: make executable
    ansible.builtin.command:
     cmd: "chmod +x gnome-shell-extension-installer"

  - name: mv Gnome Shell extension Installer
    ansible.builtin.command:
     cmd: "mv gnome-shell-extension-installer /usr/bin/" 
